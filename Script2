-- =================================================================
-- Nando Hub | v11.0 | Anti-Crash Edition (Part 1/4)
-- =================================================================

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- [[ CHECK EXECUTOR ]]
if not Drawing then
    LocalPlayer:Kick("Erro: Teu executor não suporta Drawing API.")
    return
end

-- [[ 1. CONFIGURAÇÕES ]]
getgenv().Config = {
    Aim = {
        Rage = false,      -- Hard Lock
        Legit = false,     -- Suave
        Part = "Head",
        Speed = 0.5,
        WallCheck = true,
        TeamCheck = true,
        Key = Enum.UserInputType.MouseButton2,
        FOV = { Enabled = false, Radius = 100, Color = Color3.fromRGB(255, 255, 255) }
    },
    ESP = {
        Enabled = false, Box = false, Tracer = false, Name = false, HP = false,
        TeamCheck = true, Cache = {} 
    },
    Player = {
        Fly = false, FlySpeed = 50, FlyDir = 0,
        NoClip = false, Speed = 16, Jump = 50
    }
}

-- [[ 2. CÍRCULO FOV ]]
local Circle = Drawing.new("Circle")
Circle.Thickness = 2
Circle.NumSides = 64
Circle.Filled = false
Circle.Visible = false
Circle.ZIndex = 999

-- [[ 3. FUNÇÕES DE MIRA ]]
local function isVisible(part)
    if not getgenv().Config.Aim.WallCheck then return true end
    local params = RaycastParams.new()
    params.FilterType = Enum.RaycastFilterType.Exclude
    params.FilterDescendantsInstances = {LocalPlayer.Character, Camera}
    local res = Workspace:Raycast(Camera.CFrame.Position, (part.Position - Camera.CFrame.Position).Unit * 1000, params)
    return not res or (res.Instance and res.Instance:IsDescendantOf(part.Parent))
end

local function getTarget()
    local target, minDist = nil, getgenv().Config.Aim.FOV.Radius
    local center = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)

    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("Humanoid") and p.Character.Humanoid.Health > 0 then
            if getgenv().Config.Aim.TeamCheck and p.Team == LocalPlayer.Team then continue end
            
            local part = p.Character:FindFirstChild(getgenv().Config.Aim.Part) or p.Character:FindFirstChild("HumanoidRootPart")
            if part then
                if getgenv().Config.Aim.WallCheck and not isVisible(part) then continue end
                local pos, onScreen = Camera:WorldToViewportPoint(part.Position)
                if onScreen then
                    local dist = (Vector2.new(pos.X, pos.Y) - center).Magnitude
                    if dist <= getgenv().Config.Aim.FOV.Radius and dist < minDist then
                        minDist = dist
                        target = part
                    end
                end
            end
        end
    end
    return target
end

-- [[ 4. AIMBOT HARD LOCK (BIND TO RENDER STEP 300) ]]
RunService:BindToRenderStep("NandoLockFix", 300, function()
    Circle.Visible = getgenv().Config.Aim.FOV.Enabled
    Circle.Radius = getgenv().Config.Aim.FOV.Radius
    Circle.Position = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
    Circle.Color = getgenv().Config.Aim.FOV.Color

    if not (getgenv().Config.Aim.Rage or getgenv().Config.Aim.Legit) then return end
    if not UserInputService:IsMouseButtonPressed(getgenv().Config.Aim.Key) then return end

    local t = getTarget()
    if t then
        if getgenv().Config.Aim.Rage then
            Camera.CFrame = CFrame.new(Camera.CFrame.Position, t.Position)
        elseif getgenv().Config.Aim.Legit then
            local targetCF = CFrame.new(Camera.CFrame.Position, t.Position)
            Camera.CFrame = Camera.CFrame:Lerp(targetCF, getgenv().Config.Aim.Speed)
        end
    end
end)
-- =================================================================
-- Nando Hub | v11.0 | Part 2/4 (ESP Fixed)
-- =================================================================

local function clearESP()
    for _, list in pairs(getgenv().Config.ESP.Cache) do
        for _, d in pairs(list) do d:Remove() end
    end
    getgenv().Config.ESP.Cache = {}
end

local function newDraw(type, props)
    local d = Drawing.new(type)
    for k, v in pairs(props) do d[k] = v end
    return d
end

RunService.RenderStepped:Connect(function()
    if not getgenv().Config.ESP.Enabled then clearESP(); return end

    for _, p in ipairs(Players:GetPlayers()) do
        -- Verificação de segurança
        if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("HumanoidRootPart") and p.Character:FindFirstChild("Humanoid") and p.Character.Humanoid.Health > 0 then
            
            local isAlly = (getgenv().Config.ESP.TeamCheck and p.Team == LocalPlayer.Team)
            if isAlly then
                if getgenv().Config.ESP.Cache[p] then for _, d in pairs(getgenv().Config.ESP.Cache[p]) do d.Visible = false end end
                continue
            end

            -- Inicializar Cache
            if not getgenv().Config.ESP.Cache[p] then
                getgenv().Config.ESP.Cache[p] = {
                    Box = newDraw("Square", {Thickness = 1.5, Color = Color3.fromRGB(255, 0, 0), Filled = false, ZIndex = 2}),
                    Tracer = newDraw("Line", {Thickness = 1, Color = Color3.fromRGB(255, 0, 0), ZIndex = 1}),
                    Name = newDraw("Text", {Size = 14, Center = true, Outline = true, Color = Color3.white, ZIndex = 3}),
                    HP = newDraw("Text", {Size = 12, Center = true, Outline = true, Color = Color3.fromRGB(0, 255, 0), ZIndex = 3})
                }
            end

            local cache = getgenv().Config.ESP.Cache[p]
            local root = p.Character.HumanoidRootPart
            local head = p.Character:FindFirstChild("Head") or root
            
            local vec, onScreen = Camera:WorldToViewportPoint(root.Position)

            -- [[ CORREÇÃO DO ERRO ]]
            if onScreen then
                -- Usamos pcall para evitar que cálculos matemáticos quebrem o script
                local success, err = pcall(function()
                    local headPos = Camera:WorldToViewportPoint(head.Position + Vector3.new(0, 0.5, 0))
                    local legPos = Camera:WorldToViewportPoint(root.Position - Vector3.new(0, 3, 0))
                    
                    -- Proteção contra valores Nil ou NaN
                    if not headPos or not legPos then return end

                    local h = math.abs(headPos.Y - legPos.Y)
                    local w = h / 1.8

                    -- Box
                    if getgenv().Config.ESP.Box then
                        cache.Box.Visible = true
                        cache.Box.Size = Vector2.new(w, h)
                        cache.Box.Position = Vector2.new(vec.X - w/2, vec.Y - h/2)
                    else cache.Box.Visible = false end

                    -- Tracer
                    if getgenv().Config.ESP.Tracer then
                        cache.Tracer.Visible = true
                        cache.Tracer.From = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y)
                        cache.Tracer.To = Vector2.new(vec.X, vec.Y + h/2)
                    else cache.Tracer.Visible = false end

                    -- Nome
                    if getgenv().Config.ESP.Name then
                        cache.Name.Visible = true
                        cache.Name.Text = p.DisplayName or p.Name
                        cache.Name.Position = Vector2.new(vec.X, vec.Y - h/2 - 16)
                    else cache.Name.Visible = false end

                    -- HP
                    if getgenv().Config.ESP.HP then
                        cache.HP.Visible = true
                        cache.HP.Text = math.floor(p.Character.Humanoid.Health) .. "%"
                        cache.HP.Position = Vector2.new(vec.X, vec.Y + h/2 + 2)
                        cache.HP.Color = Color3.fromHSV(p.Character.Humanoid.Health/100 * 0.3, 1, 1)
                    else cache.HP.Visible = false end
                end)

                if not success then
                    -- Se der erro no cálculo, esconde tudo para não bugar a tela
                    for _, d in pairs(cache) do d.Visible = false end
                end
            else
                for _, d in pairs(cache) do d.Visible = false end
            end
        else
            if getgenv().Config.ESP.Cache[p] then
                for _, d in pairs(getgenv().Config.ESP.Cache[p]) do d.Visible = false end
            end
        end
    end
end)

LocalPlayer.CharacterRemoving:Connect(clearESP)
-- =================================================================
-- Nando Hub | v11.0 | Part 3/4 (Controls)
-- =================================================================

-- [[ UI DE VOO MOBILE ]]
if game.CoreGui:FindFirstChild("NandoFlyUI") then game.CoreGui.NandoFlyUI:Destroy() end
local FlyGui = Instance.new("ScreenGui", game:GetService("CoreGui"))
FlyGui.Name = "NandoFlyUI"
FlyGui.Enabled = false

local function createFlyBtn(text, pos, dir)
    local btn = Instance.new("TextButton", FlyGui)
    btn.Size = UDim2.fromOffset(60, 60)
    btn.Position = pos
    btn.Text = text
    btn.TextSize = 25
    btn.Font = Enum.Font.GothamBold
    btn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    btn.TextColor3 = Color3.white
    btn.BackgroundTransparency = 0.3
    
    local uic = Instance.new("UICorner", btn); uic.CornerRadius = UDim.new(0, 15)
    local uis = Instance.new("UIStroke", btn); uis.Color = Color3.fromRGB(170, 0, 255); uis.Thickness = 2
    
    btn.MouseButton1Down:Connect(function() getgenv().Config.Player.FlyDir = dir end)
    btn.MouseButton1Up:Connect(function() getgenv().Config.Player.FlyDir = 0 end)
end

createFlyBtn("⬆", UDim2.new(0.85, 0, 0.50, 0), 1)
createFlyBtn("⬇", UDim2.new(0.85, 0, 0.65, 0), -1)

-- [[ FÍSICA ]]
RunService.Stepped:Connect(function()
    if getgenv().Config.Player.NoClip and LocalPlayer.Character then
        for _, part in pairs(LocalPlayer.Character:GetDescendants()) do
            if part:IsA("BasePart") then part.CanCollide = false end
        end
    end
    
    if getgenv().Config.Player.Fly and LocalPlayer.Character then
        local root = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        if root then
            root.Velocity = Vector3.zero
            local move = LocalPlayer.Character.Humanoid.MoveDirection * getgenv().Config.Player.FlySpeed
            local upDown = Vector3.new(0, getgenv().Config.Player.FlyDir * (getgenv().Config.Player.FlySpeed * 0.8), 0)
            root.CFrame = root.CFrame + (move * 0.03) + (upDown * 0.03)
        end
    end
end)

-- Loop de Stats (Speed/Jump)
task.spawn(function()
    while task.wait(0.5) do
        pcall(function()
            local hum = LocalPlayer.Character.Humanoid
            if getgenv().Config.Player.Speed ~= 16 then hum.WalkSpeed = getgenv().Config.Player.Speed end
            if getgenv().Config.Player.Jump ~= 50 then hum.JumpPower = getgenv().Config.Player.Jump end
        end)
    end
end)
-- =================================================================
-- Nando Hub | v11.0 | Part 4/4 (UI & Status)
-- =================================================================

local WindUI = loadstring(game:HttpGet("https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"))()
local Window = WindUI:CreateWindow({
    Title = "Nando Hub", Author = "nandoxx._.", Size = UDim2.fromOffset(550, 400), Theme = "Dark"
})

local TabPlayer = Window:Tab({ Title = "Player", Icon = "user" })
local TabAimbot = Window:Tab({ Title = "Aimbot", Icon = "crosshair" })
local TabEsp = Window:Tab({ Title = "Esp", Icon = "eye" })
local TabInfo = Window:Tab({ Title = "Info", Icon = "info" })

-- [[ STATUS ]]
local SectStats = TabPlayer:Section({ Title = "Status" })
local pIcon = "rbxassetid://10723415903"
pcall(function() pIcon = Players:GetUserThumbnailAsync(LocalPlayer.UserId, Enum.ThumbnailType.HeadShot, Enum.ThumbnailSize.Size420x420) end)
local StatsTxt = SectStats:Paragraph({ Title = LocalPlayer.DisplayName, Desc = "Loading...", Image = pIcon, ImageSize = 50 })

task.spawn(function()
    while task.wait(1) do
        local ping = 0; pcall(function() ping = math.floor(game:GetService("Stats").Network.ServerStatsItem["Data Ping"]:GetValue()) end)
        local fps = math.floor(workspace:GetRealPhysicsFPS())
        local fC = fps > 45 and "#00ff00" or (fps > 25 and "#ffff00" or "#ff0000")
        local pC = ping < 100 and "#00ff00" or (ping < 250 and "#ffff00" or "#ff0000")
        StatsTxt:SetDesc(string.format("FPS: <font color='%s'>%d</font> | Ping: <font color='%s'>%d ms</font>", fC, fps, pC, ping))
    end
end)

-- [[ UI PLAYER ]]
local SectPlr = TabPlayer:Section({ Title = "Movimento" })
SectPlr:Toggle({ Title = "Fly (Voo)", Callback = function(v) 
    getgenv().Config.Player.Fly = v
    FlyGui.Enabled = v 
    if LocalPlayer.Character then LocalPlayer.Character.Humanoid.PlatformStand = v end
end })
SectPlr:Toggle({ Title = "NoClip", Callback = function(v) getgenv().Config.Player.NoClip = v end })
SectPlr:Slider({ Title = "Velocidade", Value = {Min=16, Max=200, Default=16}, Callback = function(v) getgenv().Config.Player.Speed = v end })
SectPlr:Slider({ Title = "Pulo (Jump)", Value = {Min=50, Max=300, Default=50}, Callback = function(v) getgenv().Config.Player.Jump = v end })

-- [[ UI AIMBOT ]]
local SectAim = TabAimbot:Section({ Title = "Combate" })
SectAim:Toggle({ Title = "RAGE Aimbot (Hard Lock)", Callback = function(v) getgenv().Config.Aim.Rage = v; if v then getgenv().Config.Aim.Legit = false end end })
SectAim:Toggle({ Title = "Legit Aimbot (Suave)", Callback = function(v) getgenv().Config.Aim.Legit = v; if v then getgenv().Config.Aim.Rage = false end end })
SectAim:Slider({ Title = "Velocidade Legit", Desc = "1 = Rápido | 0.1 = Lento", Value = {Min=0.1, Max=1, Default=0.5}, Step=0.1, Callback = function(v) getgenv().Config.Aim.Speed = v end })
SectAim:Dropdown({ Title = "Alvo", Values = {"Head", "HumanoidRootPart"}, Value="Head", Callback = function(v) getgenv().Config.Aim.Part = v end })
SectAim:Toggle({ Title = "Wall Check", Value = true, Callback = function(v) getgenv().Config.Aim.WallCheck = v end })
SectAim:Toggle({ Title = "Team Check", Value = true, Callback = function(v) getgenv().Config.Aim.TeamCheck = v end })
SectAim:Divider()
SectAim:Toggle({ Title = "Mostrar FOV", Callback = function(v) getgenv().Config.Aim.FOV.Enabled = v end })
SectAim:Slider({ Title = "Raio FOV", Value = {Min=50, Max=600, Default=100}, Callback = function(v) getgenv().Config.Aim.FOV.Radius = v end })

-- [[ UI ESP ]]
local SectEsp = TabEsp:Section({ Title = "Visuais" })
SectEsp:Toggle({ Title = "Ativar ESP Mestre", Callback = function(v) getgenv().Config.ESP.Enabled = v end })
SectEsp:Toggle({ Title = "Team Check", Value=true, Callback = function(v) getgenv().Config.ESP.TeamCheck = v end })
SectEsp:Toggle({ Title = "Caixas (Box)", Callback = function(v) getgenv().Config.ESP.Box = v end })
SectEsp:Toggle({ Title = "Tracers (Linhas)", Callback = function(v) getgenv().Config.ESP.Tracer = v end })
SectEsp:Toggle({ Title = "Nomes", Callback = function(v) getgenv().Config.ESP.Name = v end })
SectEsp:Toggle({ Title = "Vida (HP)", Callback = function(v) getgenv().Config.ESP.HP = v end })

TabInfo:Section({ Title = "Sobre" }):Paragraph({ Title = "Nando Hub", Desc = "v11.0 Anti-Crash\nCorreção do Erro de Linha" })

WindUI:Notify({ Title = "Pronto!", Content = "Anti-Crash ativado.", Duration = 4 })
