-- =================================================================
-- Nando Hub | v1.9 | Aimbot/ESP Estável (Corrigido IAmxit)
-- =================================================================

-- =================================================================
-- LÓGICA DE CONTADOR DE EXECUÇÕES 
-- =================================================================

local EXEC_FILENAME = "NandoHub_Executions.txt"
local currentExecs = 0

pcall(function()
    if isfile and isfile(EXEC_FILENAME) and readfile then
        local savedData = readfile(EXEC_FILENAME)
        if savedData then
            currentExecs = tonumber(savedData) or 0
        end
    end
end)

currentExecs = currentExecs + 1

pcall(function()
    if writefile then
        writefile(EXEC_FILENAME, tostring(currentExecs))
    end
end)


-- Carregar a Biblioteca WindUI
local WindUI = loadstring(game:HttpGet("https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"))()

-- --- SERVIÇOS & VARS ---
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local Mouse = LocalPlayer:GetMouse()
local UserInputService = game:GetService("UserInputService")

-- Estado de Voo
local flyState = 0 
-- Variáveis de Estado (Aimbot/Trigger)
local aimbotLegitEnabled = false 
local aimbotRageEnabled = false 
local aimbotEnabled = false 
local fovEnabled = false
local fovSize = 100
local fovTransparency = 0.3 
local aimConnection = nil
local rageConnection = nil -- NOVO: Conexão dedicada para o modo Rage
local triggerbotEnabled = false
local triggerWallCheckEnabled = false
local triggerTeamCheckEnabled = false
local triggerConnection = nil

-- NOVO: Configurações Detalhadas do Aimbot (Legit/Precise) - BASE IAmxit
local aimPreciseConfig = {
    parteAlvo = "Head", 
    suavidade = 0.5, -- Valor de 0.1 (Lento) a 1.0 (Instantâneo)
    visibilidade = true, -- Checa Raycast
    teamCheck = true, -- Checa Team
    requerTecla = false, -- Se precisa segurar uma tecla
    tecla = Enum.UserInputType.MouseButton1 -- Padrão: Botão Esquerdo do Mouse
}

-- NOVO: Configurações do ESP (Visuals) - BASE IAmxit
local espConfig = {
    ativo = false,
    Box = true, 
    Esqueleto = false, 
    Tracers = false, 
    Username = false, 
    DisplayName = false, 
    Vida = false, 
    Item = false,
    Aim = false,
    Distancia = true,
    TeamCheck = true,
    Drawings = {} -- Cache para os objetos Drawing.new
}

local isShooting = false 
local fovCircle = nil 

-- --- DETEÇÃO DE DISPARO ---
UserInputService.InputBegan:Connect(function(input, gameProcessedEvent)
    if not gameProcessedEvent and (input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch) then
        isShooting = true
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        isShooting = false
    end
end)

-- --- CRIAÇÃO DA JANELA E TABS ---
local Window = WindUI:CreateWindow({
    Title = "Nando Hub",
    Icon = "rbxassetid://10723415903",
    Author = "nandoxx._.",
    Folder = "NandoHub",
    Size = UDim2.fromOffset(580, 460),
    Transparent = true,
    Theme = "Dark",
    SideBarWidth = 170,
    HasOutline = true,
})

-- --- TAGS E NOTIFICAÇÃO DE INÍCIO ---

Window:Tag({ Title = "v1.9 | Aimbot/ESP Estável", Icon = "check", Color = Color3.fromHex("#30ff6a"), Radius = 0 })
Window:Tag({ Title = "Execuções: " .. currentExecs, Icon = "counter", Color = Color3.fromHex("#ffa500"), Radius = 0 })

WindUI:Notify({ 
    Title = "Nando Hub Carregado", 
    Content = string.format("Bem-vindo(a), %s! (Execução #%d)", LocalPlayer.Name, currentExecs), 
    Duration = 4, 
    Icon = "check", 
})

local TabInfo = Window:Tab({ Title = "Informações", Icon = "info" })
local TabPlayer = Window:Tab({ Title = "Player", Icon = "user" })
local TabAimbot = Window:Tab({ Title = "Aimbot", Icon = "crosshair" })
local TabEsp = Window:Tab({ Title = "Esp", Icon = "eye" })
local TabOutros = Window:Tab({ Title = "Outros", Icon = "settings" })


-- =================================================================
-- LÓGICA DE AIMBOT/RAYCASTING (v1.9: Raycast/Visibilidade Corrigida)
-- =================================================================

-- Raycasting robusto (BASE IAmxit)
local function canSeeTarget(targetPart)
    if not targetPart or not targetPart.Parent or not LocalPlayer.Character then return false end
    
    local rayOrigin = Camera.CFrame.Position
    local rayDirection = (targetPart.Position - rayOrigin).Unit * 1000 
    local rayParams = RaycastParams.new()
    
    rayParams.FilterType = Enum.RaycastFilterType.Blacklist
    rayParams.FilterDescendantsInstances = {LocalPlayer.Character, targetPart.Parent} 
    
    local result = workspace:Raycast(rayOrigin, rayDirection, rayParams)
    
    return not result or (result.Instance and result.Instance:IsDescendantOf(targetPart.Parent)) 
end

-- Helper para a parte do corpo
local function getTargetPart(char)
    local part = char:FindFirstChild(aimPreciseConfig.parteAlvo) 
    return part or char:FindFirstChild("HumanoidRootPart")
end

-- Lógica de seleção de alvo (CORRIGIDA)
local function getNearestTarget()
    local myRoot = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not myRoot then return nil end

    local nearestTarget = nil
    local smallestFov = fovSize + 1
    local origin = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
    
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("Humanoid") and player.Character.Humanoid.Health > 0 then
            
            local targetChar = player.Character
            local targetPart = getTargetPart(targetChar)
            
            if targetPart then
                local screenPoint, isonScreen = Camera:WorldToScreenPoint(targetPart.Position)
                
                if isonScreen then
                    local distance = (Vector2.new(screenPoint.X, screenPoint.Y) - origin).Magnitude
                    
                    if distance <= fovSize then
                        
                        -- CORREÇÃO WALL CHECK: Só verifica a visibilidade se a opção estiver LIGADA
                        if aimPreciseConfig.visibilidade and not canSeeTarget(targetPart) then continue end
                        
                        -- Lógica de Team Check
                        if aimPreciseConfig.teamCheck and player.Team == LocalPlayer.Team then continue end

                        if distance < smallestFov then
                            smallestFov = distance
                            nearestTarget = targetPart 
                        end
                    end
                end
            end
        end
    end
    return nearestTarget
end

-- --- FOV FUNÇÕES (Mantidas) ---
local function createFovCircle()
    local playerGui = LocalPlayer:FindFirstChild("PlayerGui")
    if not playerGui then return end
    local ScreenGui = playerGui:FindFirstChild("AimbotFovGui") or Instance.new("ScreenGui")
    ScreenGui.Name = "AimbotFovGui"
    ScreenGui.DisplayOrder = 999
    ScreenGui.Parent = playerGui
    fovCircle = ScreenGui:FindFirstChild("FovFrame") or Instance.new("Frame")
    fovCircle.Name = "FovFrame"
    fovCircle.AnchorPoint = Vector2.new(0.5, 0.5)
    fovCircle.BackgroundTransparency = 1
    fovCircle.ZIndex = 1
    local UICorner = fovCircle:FindFirstChild("UICorner") or Instance.new("UICorner")
    UICorner.CornerRadius = UDim.new(1, 0) 
    UICorner.Parent = fovCircle
    local UIStroke = fovCircle:FindFirstChild("UIStroke") or Instance.new("UIStroke")
    UIStroke.Thickness = 3 
    UIStroke.Color = Color3.new(1, 1, 1) 
    UIStroke.Transparency = fovTransparency 
    UIStroke.LineJoinMode = Enum.LineJoinMode.Round
    UIStroke.Parent = fovCircle
    fovCircle.Parent = ScreenGui
    return fovCircle
end

local function updateFov()
    if not fovEnabled and fovCircle and fovCircle.Visible then
        fovCircle.Visible = false
        return
    elseif not fovEnabled then
        if fovCircle then fovCircle.Visible = false end
        return
    end
    if not fovCircle or not fovCircle.Parent then
        fovCircle = createFovCircle()
    end
    if not fovCircle then return end
    local size = UDim2.new(0, fovSize * 2, 0, fovSize * 2)
    fovCircle.Size = size
    fovCircle.Position = UDim2.new(0.5, 0, 0.5, 0)
    fovCircle.Visible = true
    local uiStroke = fovCircle:FindFirstChild("UIStroke")
    if uiStroke then
        uiStroke.Transparency = fovTransparency
        uiStroke.Thickness = 3
    end
end

LocalPlayer.CharacterAdded:Connect(function(character)
    if fovEnabled then
        task.spawn(function()
            task.wait(0.5) 
            updateFov()
        end)
    end
end)


-- AIMBOT LOOP PRINCIPAL (v1.9: Rage RenderStepped)
local function updateAimbotState()
    doAimbot()
end

local function doAimbot()
    local isRageActive = aimbotRageEnabled
    local isLegitActive = aimbotLegitEnabled
    
    local function checkActivationKey()
        return not aimPreciseConfig.requerTecla or UserInputService:IsKeyPressed(aimPreciseConfig.tecla) or UserInputService:IsMouseButtonPressed(aimPreciseConfig.tecla)
    end
    
    -- GERENCIAMENTO DA CONEXÃO LEGIT (Heartbeat)
    if not isLegitActive and aimConnection then
        aimConnection:Disconnect()
        aimConnection = nil
    elseif isLegitActive and aimConnection == nil then
        aimConnection = RunService.Heartbeat:Connect(function()
            if not checkActivationKey() then return end
            
            updateFov()

            local target = getNearestTarget()
            
            if target then
                local targetPos = target.Position
                local newCFrame = CFrame.lookAt(Camera.CFrame.Position, targetPos)
                Camera.CFrame = Camera.CFrame:Lerp(newCFrame, aimPreciseConfig.suavidade)
            end
        end)
    end
    
    -- GERENCIAMENTO DA CONEXÃO RAGE (RenderStepped - MAIS RÁPIDO)
    if not isRageActive and rageConnection then
        rageConnection:Disconnect()
        rageConnection = nil
    elseif isRageActive and rageConnection == nil then
        rageConnection = RunService.RenderStepped:Connect(function()
            if not checkActivationKey() then return end
            
            updateFov()

            local target = getNearestTarget()
            
            if target then
                local targetPos = target.Position
                local newCFrame = CFrame.lookAt(Camera.CFrame.Position, targetPos)
                Camera.CFrame = newCFrame -- Instantâneo
            end
        end)
    end
end

-- --- TRIGGER BOT LOOP (Mantido, mas precisa de correção para funcionar) ---
local function doTriggerBot()
    if not triggerbotEnabled and triggerConnection then
        triggerConnection:Disconnect()
        triggerConnection = nil
        return
    end
    
    if triggerbotEnabled and triggerConnection == nil then
        triggerConnection = RunService.Heartbeat:Connect(function()
            task.wait(0.03) -- Atraso para evitar spam de click em jogos pesados
            
            local center = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
            local unitRay = Camera:ViewportPointToRay(center.X, center.Y)
            
            local params = RaycastParams.new()
            params.FilterDescendantsInstances = { LocalPlayer.Character }
            params.FilterType = Enum.RaycastFilterType.Exclude

            local result = workspace:Raycast(unitRay.Origin, unitRay.Direction * 1000, params)
            
            if result then
                local targetHumanoid = result.Instance.Parent:FindFirstChildOfClass("Humanoid")
                
                if targetHumanoid and targetHumanoid.Health > 0 and targetHumanoid.Parent ~= LocalPlayer.Character then
                    
                    local targetPlayer = Players:GetPlayerFromCharacter(targetHumanoid.Parent)
                    
                    -- Team Check e Wall Check usam as vars do Trigger Bot, mantido
                    if triggerTeamCheckEnabled and targetPlayer and targetPlayer.Team == LocalPlayer.Team then return end
                    -- NOTA: O Trigger Bot Wall Check ainda pode precisar de ajustes dependendo do jogo
                    if triggerWallCheckEnabled and not canSeeTarget(result.Instance) then return end

                    Mouse:Click()
                end
            end
        end)
    end
end
-- =================================================================
-- TAB: AIMBOT (UI) (v1.9)
-- =================================================================

local SectionAimbot = TabAimbot:Section({ Title = "Aimbot", Box = false, Opened = true, })

-- 1. Ativar Aimbot Legit (Suave/Rápido)
SectionAimbot:Toggle({
    Title = "Ativar Aimbot Legit",
    Desc = "Aimbot suave, puxe a mira de forma controlada.",
    Icon = "user_check",
    Type = "Checkbox",
    Value = aimbotLegitEnabled,
    Callback = function(state)
        aimbotLegitEnabled = state
        if state and aimbotRageEnabled then aimbotRageEnabled = false end 
        updateAimbotState()
        Window:Update() 
    end
})

-- 2. Ativar Aimbot Rage (Instantâneo)
SectionAimbot:Toggle({
    Title = "Ativar Aimbot RAGE",
    Desc = "Aimbot agressivo: mira instantaneamente no alvo (Max FPS).",
    Icon = "bolt",
    Type = "Checkbox",
    Value = aimbotRageEnabled,
    Callback = function(state)
        aimbotRageEnabled = state
        if state and aimbotLegitEnabled then aimbotLegitEnabled = false end 
        updateAimbotState()
        Window:Update()
    end
})

SectionAimbot:Divider()

-- 3. Slider: Suavidade Legit (BASE IAmxit)
SectionAimbot:Slider({
    Title = "Suavidade Legit (Rapidez)",
    Desc = "Define a rapidez da transição da mira (0.1 = Lento, 1.0 = Instantâneo).",
    Step = 0.05,
    Value = { Min = 0.1, Max = 1.0, Default = 0.5, }, 
    Callback = function(value)
        aimPreciseConfig.suavidade = value
    end
})

SectionAimbot:Dropdown({
    Title = "Parte do Alvo",
    Desc = "Define a parte do corpo a ser alvejada.",
    Values = { "Head", "HumanoidRootPart", "Torso", "UpperTorso" },
    Value = aimPreciseConfig.parteAlvo,
    Callback = function(option)
        aimPreciseConfig.parteAlvo = option
        WindUI:Notify({Title = "Aimbot", Content = "Alvo definido para: " .. option, Duration = 2})
    end
})

SectionAimbot:Divider()

-- 4. Toggle: Checar Visibilidade (Wall Check) (CORRIGIDO)
SectionAimbot:Toggle({
    Title = "Checar Visibilidade (Wall Check)",
    Desc = "Impede mira em inimigos atrás de paredes (Raycasting).",
    Icon = "wall_check",
    Type = "Checkbox",
    Value = aimPreciseConfig.visibilidade,
    Callback = function(state)
        aimPreciseConfig.visibilidade = state
    end
})

-- 5. Toggle: Team Check
SectionAimbot:Toggle({
    Title = "Team Check",
    Desc = "Impede que o Aimbot atinja colegas de equipa.",
    Icon = "users",
    Type = "Checkbox",
    Value = aimPreciseConfig.teamCheck,
    Callback = function(state)
        aimPreciseConfig.teamCheck = state
    end
})

SectionAimbot:Divider()

-- 6. Requer Segurar Tecla
SectionAimbot:Toggle({ 
    Title = "Requer Segurar Tecla", 
    Desc = "Aimbot só ativa se a tecla escolhida for pressionada.",
    Type = "Checkbox",
    Value = aimPreciseConfig.requerTecla,
    Callback = function(v) 
        aimPreciseConfig.requerTecla = v 
    end 
})

SectionAimbot:Dropdown({ 
    Title = "Tecla de Ativação", 
    Desc = "Tecla a ser segurada para ativar o Aimbot.",
    Values = {"MouseButton1", "MouseButton2", "E", "Q", "X", "V", "LeftShift"}, 
    Value = "MouseButton1",
    Callback = function(v) 
        if Enum.UserInputType[v] then aimPreciseConfig.tecla = Enum.UserInputType[v]
        elseif Enum.KeyCode[v] then aimPreciseConfig.tecla = Enum.KeyCode[v]
        else aimPreciseConfig.tecla = Enum.UserInputType.MouseButton1 end
        WindUI:Notify({Title = "Aimbot", Content = "Tecla definida para: " .. v, Duration = 2})
    end 
})

SectionAimbot:Divider()

-- 7. Ativar FOV
SectionAimbot:Toggle({
    Title = "Ativar FOV (Círculo)",
    Desc = "Desenha o círculo do campo de visão na tela.",
    Icon = "eye_open",
    Type = "Checkbox",
    Value = fovEnabled,
    Callback = function(state)
        fovEnabled = state
        updateFov()
    end
})

-- 8. Tamanho do FOV
SectionAimbot:Slider({
    Title = "Tamanho do FOV",
    Desc = "Define o raio do campo de visão (em pixels).",
    Step = 5,
    Value = { Min = 10, Max = 600, Default = 100, },
    Callback = function(value)
        fovSize = value
        updateFov()
    end
})

-- 9. Transparência do FOV
SectionAimbot:Slider({
    Title = "Transparência do FOV",
    Desc = "Controla a transparência do círculo FOV (0.0 = Visível, 1.0 = Invisível).",
    Step = 0.05,
    Value = { Min = 0.0, Max = 1.0, Default = 0.3, },
    Callback = function(value)
        fovTransparency = value
        updateFov()
    end
})


-- --- SECÇÃO: TRIGGER BOT (Mantido, mas requer correções no loop da Parte 1) ---
local SectionTriggerBot = TabAimbot:Section({ Title = "Trigger Bot", Box = false, Opened = true, })

SectionTriggerBot:Toggle({
    Title = "Ativar Trigger Bot",
    Desc = "Atira automaticamente quando a mira está sobre um inimigo.",
    Icon = "target",
    Type = "Checkbox",
    Value = false,
    Callback = function(state)
        triggerbotEnabled = state
        doTriggerBot() 
    end
})

SectionTriggerBot:Divider()

SectionTriggerBot:Toggle({
    Title = "Ativar Wall Check",
    Desc = "Impede o Trigger Bot de atirar através de paredes.",
    Icon = "wall_check",
    Type = "Checkbox",
    Value = false,
    Callback = function(state)
        triggerWallCheckEnabled = state
    end
})

SectionTriggerBot:Divider()

SectionTriggerBot:Toggle({
    Title = "Ativar Team Check",
    Desc = "Impede que o Trigger Bot atire em colegas de equipa.",
    Icon = "users",
    Type = "Checkbox",
    Value = false,
    Callback = function(state)
        triggerTeamCheckEnabled = state
    end
})

-- =================================================================
-- TAB: ESP / VISUALS (v1.9: Base IAmxit)
-- =================================================================

local SectionEsp = TabEsp:Section({ Title = "Configurações de ESP", Box = false, Opened = true, })

SectionEsp:Toggle({ 
    Title = "Ativar Visuals (ESP)", 
    Desc = "Ativa a renderização de todas as informações visuais (Desenho Rápido).",
    Icon = "check",
    Type = "Checkbox", 
    Value = espConfig.ativo,
    Callback = function(v) 
        espConfig.ativo = v 
    end 
})

SectionEsp:Divider()

SectionEsp:Toggle({ Title = "Checar Team (Ignorar Amigos)", Desc = "Não desenha visuais em colegas de equipa.", Icon = "users", Type = "Checkbox", Value = espConfig.TeamCheck, Callback = function(v) espConfig.TeamCheck = v end })
SectionEsp:Toggle({ Title = "Box Simples", Desc = "Desenha uma caixa 2D ao redor do alvo.", Icon = "box", Type = "Checkbox", Value = espConfig.Box, Callback = function(v) espConfig.Box = v end })
SectionEsp:Toggle({ Title = "Barra de Vida (HP)", Desc = "Mostra a barra de vida lateral.", Icon = "heart", Type = "Checkbox", Value = espConfig.Vida, Callback = function(v) espConfig.Vida = v end })
SectionEsp:Toggle({ Title = "Tracers (Linha)", Desc = "Desenha uma linha do alvo até a base da tela.", Icon = "line_chart", Type = "Checkbox", Value = espConfig.Tracers, Callback = function(v) espConfig.Tracers = v end })
SectionEsp:Toggle({ Title = "Distância", Desc = "Mostra a distância em metros até o alvo.", Icon = "distance", Type = "Checkbox", Value = espConfig.Distancia, Callback = function(v) espConfig.Distancia = v end })
SectionEsp:Toggle({ Title = "Username ESP", Desc = "Mostra o nome de utilizador (Account Name).", Icon = "user", Type = "Checkbox", Value = espConfig.Username, Callback = function(v) espConfig.Username = v end })
SectionEsp:Toggle({ Title = "Display Name ESP", Desc = "Mostra o nome de exibição.", Icon = "id_badge", Type = "Checkbox", Value = espConfig.DisplayName, Callback = function(v) espConfig.DisplayName = v end })
SectionEsp:Toggle({ Title = "Item Segurado", Desc = "Mostra o nome da ferramenta que o alvo está segurando.", Icon = "tool", Type = "Checkbox", Value = espConfig.Item, Callback = function(v) espConfig.Item = v end })
SectionEsp:Toggle({ Title = "Linha da Mira (Head Look)", Desc = "Desenha uma linha na direção que a cabeça do alvo está a olhar.", Icon = "eye_open", Type = "Checkbox", Value = espConfig.Aim, Callback = function(v) espConfig.Aim = v end })
-- =================================================================
-- RESTO DO SCRIPT (PLAYER, FLY, INFO)
-- =================================================================

-- TAB: INFORMAÇÕES (Mantido)
local SectionCreditos = TabInfo:Section({ Title = "Creditos", Box = false, Opened = true, })
SectionCreditos:Paragraph({ Title = "Credits / Créditos", Desc = "Developed by: nandoxx._. on discord", Locked = false, })
SectionCreditos:Paragraph({ Title = "Dates / Datas", Desc = "Created: December 12, 2025 (12 de Dezembro de 2025)\nLast Update: December 12, 2025 (12 de Dezembro de 2025)", Locked = false, })

-- TAB: PLAYER (Mantido)
local SectionPlayerInfo = TabPlayer:Section({ Title = "Informações do Player", Box = false, Opened = true, })

local playerIcon = "rbxassetid://10723415903"
pcall(function()
    playerIcon = Players:GetUserThumbnailAsync(LocalPlayer.UserId, Enum.ThumbnailType.HeadShot, Enum.ThumbnailSize.Size420x420)
end)

local StatusParagraph = SectionPlayerInfo:Paragraph({
    Title = LocalPlayer.DisplayName .. " (@" .. LocalPlayer.Name .. ")",
    Desc = "Calculando Ping e FPS...",
    Image = playerIcon, 
    ImageSize = 50,
    Locked = false,
})

task.spawn(function()
    while task.wait(1) do
        if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("Humanoid") then
            StatusParagraph:SetDesc("Aguardando carregamento do Character...")
            continue
        end

        local stats = game:GetService("Stats")
        local ping = 0
        pcall(function() ping = math.floor(stats.Network.ServerStatsItem["Data Ping"]:GetValue()) end)
        
        local fps = math.floor(workspace:GetRealPhysicsFPS())
        
        local fpsColor = "ff0000"
        if fps >= 50 then fpsColor = "00ff00"
        elseif fps >= 30 then fpsColor = "ffff00" end
        
        local pingColor = "ff0000"
        if ping < 100 then pingColor = "00ff00"
        elseif ping < 200 then pingColor = "ffff00" end

        StatusParagraph:SetDesc(
            string.format("FPS: <font color='#%s'>%d</font> | Ping: <font color='#%s'>%d ms</font>", fpsColor, fps, pingColor, ping)
        )
    end
end)

-- --- IMPLEMENTAÇÃO DOS BOTÕES DE ALTITUDE (UP/DOWN) ---
local ScreenGuiControls = Instance.new("ScreenGui")
ScreenGuiControls.Name = "NandoHubAltitudeControls"
ScreenGuiControls.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

local function createButton(name, position, size, text, state)
    local btn = Instance.new("TextButton")
    btn.Name = name
    btn.Size = size
    btn.Position = position
    btn.Text = text
    btn.Font = Enum.Font.SourceSans
    btn.TextSize = 20
    btn.TextColor3 = Color3.new(1, 1, 1)
    btn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    btn.BorderColor3 = Color3.fromRGB(0, 0, 0)
    btn.BorderSizePixel = 1
    btn.Visible = false
    
    btn.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseButton1 then
            flyState = state
        end
    end)
    
    btn.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseButton1 then
            if flyState == state then flyState = 0 end
        end
    end)
    
    btn.Parent = ScreenGuiControls
    return btn
end

local btnUp = createButton("UpButton", UDim2.new(1, -120, 1, -180), UDim2.new(0, 100, 0, 60), "UP", 1)
local btnDown = createButton("DownButton", UDim2.new(1, -120, 1, -100), UDim2.new(0, 100, 0, 60), "DOWN", -1)

ScreenGuiControls.Parent = LocalPlayer:WaitForChild("PlayerGui")

-- --- SECÇÃO: FLY ---
local SectionFly = TabPlayer:Section({ Title = "Fly", Box = false, Opened = true, })
local flyEnabled = false
local flySpeed = 50
local bodyVelocity = nil
local bodyGyro = nil

local function updateFly()
    local char = LocalPlayer.Character
    local root = char and char:FindFirstChild("HumanoidRootPart")
    local hum = char and char:FindFirstChild("Humanoid")
    
    if flyEnabled and root and hum then
        btnUp.Visible = true
        btnDown.Visible = true
        
        if not bodyVelocity then
            bodyVelocity = Instance.new("BodyVelocity")
            bodyVelocity.MaxForce = Vector3.new(9e9, 9e9, 9e9)
            bodyVelocity.Parent = root
            
            bodyGyro = Instance.new("BodyGyro")
            bodyGyro.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
            bodyGyro.P = 10000
            bodyGyro.D = 100
            bodyGyro.Parent = root
            
            hum.PlatformStand = true
        end
        
        task.spawn(function()
            while flyEnabled and root and bodyVelocity do
                local cam = workspace.CurrentCamera
                local horizontalMoveDir = hum.MoveDirection * flySpeed
                local verticalMove = Vector3.new(0, flyState * flySpeed, 0)
                
                bodyVelocity.Velocity = horizontalMoveDir + verticalMove
                
                if bodyGyro then bodyGyro.CFrame = cam.CFrame end
                RunService.Stepped:Wait() 
            end
        end)
    else
        btnUp.Visible = false
        btnDown.Visible = false
        flyState = 0
        
        if bodyVelocity then bodyVelocity:Destroy() bodyVelocity = nil end
        if bodyGyro then bodyGyro:Destroy() bodyGyro = nil end
        if hum then hum.PlatformStand = false end
    end
end

SectionFly:Toggle({ Title = "Fly", Desc = "Ativa o modo de voo. Use os botões UP/DOWN na tela para altitude.", Icon = "rocket", Type = "Checkbox", Value = false, Callback = function(state) flyEnabled = state updateFly() end })
SectionFly:Slider({ Title = "Fly Speed", Desc = "Controla a velocidade horizontal e vertical do voo.", Step = 1, Value = { Min = 16, Max = 200, Default = 50, }, Callback = function(value) flySpeed = value end })
SectionFly:Divider()

-- --- SECÇÃO: NO CLIP ---
local SectionNoClip = TabPlayer:Section({ Title = "No Clip", Box = false, Opened = true, })
local noclipEnabled = false
local noclipConnection = nil

SectionNoClip:Toggle({
    Title = "Ativar NoClip",
    Desc = "Desativa a colisão do personagem (Permite atravessar paredes).",
    Icon = "shield_off",
    Type = "Checkbox",
    Value = false,
    Callback = function(state)
        noclipEnabled = state
        WindUI:Notify({Title = "NoClip", Content = "Estado: " .. (noclipEnabled and "Ativado" or "Desativado"), Duration = 2})
        
        if noclipEnabled then
            noclipConnection = RunService.Stepped:Connect(function()
                if LocalPlayer.Character then
                    for _, v in pairs(LocalPlayer.Character:GetDescendants()) do
                        if v:IsA("BasePart") and v.CanCollide == true then
                            v.CanCollide = false
                        end
                    end
                end
            end)
        else
            if noclipConnection then noclipConnection:Disconnect() noclipConnection = nil end
        end
    end
})

-- --- SECÇÃO: PLAYER SPEED ---
local SectionSpeed = TabPlayer:Section({ Title = "Player Speed", Box = false, Opened = true, })
local speedEnabled = false
local speedValue = 16

task.spawn(function()
    while task.wait(0.5) do
        if speedEnabled and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
            LocalPlayer.Character.Humanoid.WalkSpeed = speedValue
        end
    end
end)

SectionSpeed:Toggle({ Title = "Ativar Speed", Desc = "Aumenta a velocidade de movimento do personagem.", Icon = "run", Type = "Checkbox", Value = false, Callback = function(state) speedEnabled = state if not state and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then LocalPlayer.Character.Humanoid.WalkSpeed = 16 end end })
SectionSpeed:Slider({ Title = "Player Speed", Desc = "Define o valor da velocidade de caminhada.", Step = 1, Value = { Min = 16, Max = 200, Default = 16, }, Callback = function(value) speedValue = value if speedEnabled and LocalPlayer.Character then LocalPlayer.Character.Humanoid.WalkSpeed = value end end })
SectionSpeed:Divider()

-- --- SECÇÃO: POWER JUMP ---
local SectionJump = TabPlayer:Section({ Title = "Power Jump", Box = false, Opened = true, })
local jumpEnabled = false
local jumpValue = 50

task.spawn(function()
    while task.wait(0.5) do
        if jumpEnabled and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
            LocalPlayer.Character.Humanoid.UseJumpPower = true
            LocalPlayer.Character.Humanoid.JumpPower = jumpValue
        end
    end
end)

SectionJump:Toggle({ Title = "Ativar Power Jump", Desc = "Aumenta a altura máxima do salto.", Icon = "jump", Type = "Checkbox", Value = false, Callback = function(state) jumpEnabled = state if not state and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then LocalPlayer.Character.Humanoid.JumpPower = 50 end end })
SectionJump:Slider({ Title = "Power Jump", Desc = "Define a força do salto.", Step = 1, Value = { Min = 50, Max = 300, Default = 50, }, Callback = function(value) jumpValue = value if jumpEnabled and LocalPlayer.Character then LocalPlayer.Character.Humanoid.JumpPower = value end end })


-- ====================================================================
-- NOVO: LIMPEZA DO ESP E CORREÇÃO DE BUG PÓS-MORTE (v1.9)
-- ====================================================================

local function cleanupEsp()
    -- Limpa todos os desenhos da tela
    for player, drawings in pairs(espConfig.Drawings) do
        for _, d in pairs(drawings) do 
            if d:IsA("Drawing") then d:Remove() end
        end
    end
    -- Limpa o cache de desenhos
    espConfig.Drawings = {}
end

-- Evento crucial para corrigir o bug de "fantasma" do ESP
LocalPlayer.CharacterRemoving:Connect(function()
    cleanupEsp()
end)

-- ====================================================================
-- LOOP PRINCIPAL DO ESP (v1.9: BASE IAmxit)
-- ====================================================================

RunService.RenderStepped:Connect(function()
    if not espConfig.ativo or not LocalPlayer.Character then
        -- Se o ESP está desligado, apenas esconde o que sobrou
        for _, d in pairs(espConfig.Drawings) do
            for _, item in pairs(d) do if item:IsA("Drawing") then item.Visible = false end end
        end
        return
    end
    
    local myRoot = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not myRoot then return end

    local playersInView = {}

    for _, player in ipairs(Players:GetPlayers()) do
        if player == LocalPlayer then continue end
        
        local char = player.Character
        if not char or char:FindFirstChildOfClass("Humanoid").Health <= 0 then continue end

        -- Checagem de Team
        if espConfig.TeamCheck and player.Team == LocalPlayer.Team then continue end

        local root = char:FindFirstChild("HumanoidRootPart")
        if not root then continue end

        -- 1. Posições na Tela
        local head = char:FindFirstChild("Head") or root
        local headPos, headOnScreen = Camera:WorldToViewportPoint(head.Position + Vector3.new(0, 1, 0))
        local rootPos, rootOnScreen = Camera:WorldToViewportPoint(root.Position - Vector3.new(0, root.Size.Y / 2, 0))

        if not headOnScreen and not rootOnScreen then
            if espConfig.Drawings[player] then
                for _, d in pairs(espConfig.Drawings[player]) do if d:IsA("Drawing") then d.Visible = false end end
            end
            continue
        end

        table.insert(playersInView, {player = player, char = char, headPos = headPos, rootPos = rootPos})
    end

    -- Limpa desenhos de jogadores que saíram da lista/jogo
    for player, drawings in pairs(espConfig.Drawings) do
        local found = false
        for _, item in ipairs(playersInView) do
            if item.player == player then found = true; break end
        end
        if not found then
            for _, d in pairs(drawings) do if d:IsA("Drawing") then d:Remove() end end
            espConfig.Drawings[player] = nil
        end
    end


    -- 2. DESENHAR OS VISUAIS
    for _, data in ipairs(playersInView) do
        local player, char, headPos, rootPos = data.player, data.char, data.headPos, data.rootPos
        local drawings = espConfig.Drawings[player] or {}
        espConfig.Drawings[player] = drawings

        local color = espConfig.TeamCheck and (player.Team == LocalPlayer.Team and Color3.fromRGB(0, 255, 255) or Color3.fromRGB(255, 0, 0)) or Color3.fromRGB(255, 255, 0)
        
        local function ensureDrawing(name, typeName)
            if not drawings[name] then
                drawings[name] = Drawing.new(typeName)
                drawings[name].Color = color
                drawings[name].Outline = true
                drawings[name].Visible = true
                drawings[name].ZIndex = 1
            end
            return drawings[name]
        end

        -- --- BOX ESP 
        if espConfig.Box and char:FindFirstChild("HumanoidRootPart") then
            local box = ensureDrawing("Box", "Square")
            local boxHeight = math.abs(rootPos.Y - headPos.Y)
            local boxWidth = boxHeight / 2.5 
            
            box.Size = Vector2.new(boxWidth, boxHeight)
            box.Position = Vector2.new(headPos.X, headPos.Y + boxHeight / 2)
            box.Color = color
            box.Visible = true

            -- Barra de vida lateral
            if espConfig.Vida then
                 local vidaBar = ensureDrawing("VidaBar", "Square")
                 vidaBar.Size = Vector2.new(4, boxHeight)
                 vidaBar.Position = Vector2.new(headPos.X - boxWidth/2 - 5, headPos.Y + boxHeight / 2)
                 vidaBar.Visible = true
                 vidaBar.Color = Color3.fromRGB(0, 255, 0)
                 vidaBar.Filled = true
                 
                 local hum = char:FindFirstChildOfClass("Humanoid")
                 local vidaPercent = hum.Health / hum.MaxHealth
                 
                 local vidaOverlay = ensureDrawing("VidaOverlay", "Square")
                 local overlayHeight = boxHeight * (1 - vidaPercent)
                 
                 vidaOverlay.Size = Vector2.new(4, overlayHeight)
                 vidaOverlay.Position = Vector2.new(headPos.X - boxWidth/2 - 5, headPos.Y + overlayHeight / 2)
                 vidaOverlay.Visible = true
                 vidaOverlay.Color = Color3.fromRGB(255, 0, 0)
                 vidaOverlay.Filled = true
            else
                 if drawings.VidaBar then drawings.VidaBar.Visible = false end
                 if drawings.VidaOverlay then drawings.VidaOverlay.Visible = false end
            end
        else
            if drawings.Box then drawings.Box.Box = false end
            if drawings.VidaBar then drawings.VidaBar.Visible = false end
            if drawings.VidaOverlay then drawings.VidaOverlay.Visible = false end
        end

        -- --- TRACERS 
        if espConfig.Tracers then
            local tracer = ensureDrawing("Tracer", "Line")
            tracer.From = Vector2.new(rootPos.X, rootPos.Y)
            tracer.To = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y)
            tracer.Visible = true
            tracer.Color = color
            tracer.Thickness = 2
        else
            if drawings.Tracer then drawings.Tracer.Visible = false end
        end

        -- --- TEXTO
        local yOffset = headPos.Y - 25

        if espConfig.DisplayName then
            local dn = ensureDrawing("DisplayName", "Text")
            dn.Text = player.DisplayName
            dn.Color = Color3.fromRGB(255, 255, 255)
            dn.Size = 16
            dn.Center = true
            dn.Position = Vector2.new(headPos.X, yOffset)
            dn.Visible = true
            yOffset = yOffset - 15
        else
            if drawings.DisplayName then drawings.DisplayName.Visible = false end
        end

        if espConfig.Username then
            local un = ensureDrawing("Username", "Text")
            un.Text = player.Name
            un.Color = Color3.fromRGB(0, 255, 255)
            un.Size = 14
            un.Center = true
            un.Position = Vector2.new(headPos.X, yOffset)
            un.Visible = true
            yOffset = yOffset - 15
        else
            if drawings.Username then drawings.Username.Visible = false end
        end
        
        -- --- DISTÂNCIA
        if espConfig.Distancia and myRoot and char:FindFirstChild("HumanoidRootPart") then
            local dist = ensureDrawing("Distancia", "Text")
            local distance = math.floor((myRoot.Position - char.HumanoidRootPart.Position).Magnitude)
            dist.Text = "[" .. distance .. "m]"
            dist.Color = Color3.fromRGB(255, 255, 0)
            dist.Size = 14
            dist.Center = true
            dist.Position = Vector2.new(headPos.X, yOffset)
            dist.Visible = true
            yOffset = yOffset - 15
        else
            if drawings.Distancia then drawings.Distancia.Visible = false end
        end
        
        -- --- ITEM SEGURADO
        if espConfig.Item then 
            local item = char:FindFirstChildOfClass("Tool") 
            if item and item.Name ~= "BodyPart" then
                local itemDraw = ensureDrawing("Item", "Text")
                itemDraw.Text = "Item: " .. item.Name; itemDraw.Color = Color3.fromRGB(150, 255, 150); itemDraw.Size = 14; itemDraw.Center = true;
                itemDraw.Position = Vector2.new(headPos.X, yOffset); 
                itemDraw.Visible = true
                yOffset = yOffset - 15
            else 
                if drawings.Item then drawings.Item.Visible = false end
            end 
        else 
            if drawings.Item then drawings.Item.Visible = false end
        end

        -- --- LINHA DA MIRA
        if espConfig.Aim and head then 
            local lookVector = head.CFrame.LookVector
            local aimEndPos = head.Position + (lookVector * 50)
            local aimScreenPos, aimOnScreen = Camera:WorldToViewportPoint(aimEndPos) 
            
            if aimOnScreen then 
                local aimDraw = ensureDrawing("Aim", "Line")
                aimDraw.From = Vector2.new(headPos.X, headPos.Y); 
                aimDraw.To = Vector2.new(aimScreenPos.X, aimScreenPos.Y)
                aimDraw.Color = Color3.fromRGB(255, 0, 0);
                aimDraw.Visible = true
                aimDraw.Thickness = 2
            else 
                if drawings.Aim then drawings.Aim.Visible = false end
            end 
        else
            if drawings.Aim then drawings.Aim.Visible = false end
        end
        
        if drawings.Esqueleto then drawings.Esqueleto.Visible = false end

    end
end)

Window:SelectTab(3)
